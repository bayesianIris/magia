
heresy.0006 = {
	hidden = yes
	scope = faith

	trigger = {
		# 一个永真式
		OR = {
			NOT = { has_doctrine = eastern_hostility_doctrine }
			has_doctrine = eastern_hostility_doctrine
		}
	}

	immediate = {
		#Look for a valid Duke of this Faith to be our heresiarch.
		random_faith_ruler = {
			#Prefer Dukes with only 1 or 2 Duchies.
			limit = {
				is_valid_heresiarch = yes
				highest_held_title_tier = tier_duchy
				any_held_title = {
					title_tier = duchy
					count < 3 #Limit the influence of Mega-Dukes
					is_landless_type_title = no
					is_noble_family_title = no
				}
			}
			#Then accept any valid Duke.
			alternative_limit = {
				is_valid_heresiarch = yes
				highest_held_title_tier = tier_duchy
			}
			#If no Dukes exist, accept a Count.
			alternative_limit = {
				is_valid_heresiarch = yes		
			}

			weight = {
				base = 100

				modifier = {
					add = 100
					is_powerful_vassal = yes
				}
				modifier = {
					add = 75
					top_liege = this
				}
				modifier = {
					add = 50
					is_a_faction_member = yes
				}

				modifier = {
					factor = 10
					has_game_rule = strict_regional_heresy
					trigger_if = {
						limit = {
							faith = faith:catholic
						}
						capital_county = {
							title_province = {
								OR = {
									geographical_region = world_europe_west_britannia # Lollard
									geographical_region = world_europe_west_francia # Cathar
									geographical_region = world_europe_south_italy # Walddensian
								}
							}
						}
					}
					trigger_if = {
						limit = {
							faith = faith:orthodox
						}
						capital_county = {
							title_province = {
								OR = {
									geographical_region = world_asia_minor # Paulician
									geographical_region = custom_k_thessalonika # Iconoclast
									geographical_region = world_europe_south_east # Bogomils
								}
							}
						}
					}
				}
			}

			save_scope_as = heretic_ruler
			primary_title = {
				save_scope_as = heretic_title
			}
			capital_county = {
				save_scope_as = heretic_capital
			}
		}


		#Once we have a heresiarch, look for a valid heretical faith to them to convert to.
		if = {
			limit = {
				exists = scope:heretic_ruler
			}

			#Save a list of provinces in our religion group (we will be reusing this a lot for distance checks).
			# every_province = {
			# 	limit = {
			# 		is_county_capital = yes
			# 		faith.religion = root.religion
			# 		squared_distance = {
			# 			target = scope:heretic_capital
			# 			value < squared_distance_medium
			# 		}
			# 	}
			# 	add_to_list = neaby_same_religion_counties
			# }

			# Compile a list of possible heresies to convert to.
			religion = {
				every_faith = {
					limit = {
						NOT = { invalid_for_heresy_events = yes }
					}
					add_to_list = potential_heresies
				}
				if = {
					# Abrahamics also get bonus dualistic heresies
					limit = {
						# 永远为真
						OR = {
							is_in_family = rf_abrahamic
							NOT = { is_in_family = rf_abrahamic }
						}
					}
					faith:madokamist_orthodox = {
						add_to_list = potential_heresies
					}
					faith:madokamist_martial = {
						add_to_list = potential_heresies
					}
					faith:madokamist_romance = {
						add_to_list = potential_heresies
					}
				}
			}

			#We want to pick certain faiths to be our heresy over others, assuming they are valid.

			#Trigger the heresy event for all rulers of the same Faith.
			if = {
				limit = {
					exists = scope:heretic_faith
				}

				save_scope_as = origin_faith

				#Determine roughly how many Counties we expext to flip to the heretical Faith.
				random_list = {
					20 = {
						modifier = {
							add = 20
							fervor > 30
						}
						set_variable = {
							name = heresy_power
							value = 10
						}
					}
					55 = {
						set_variable = {
							name = heresy_power
							value = 15
						}
					}
					20 = {
						modifier = {
							add = 30
							fervor <= 20
						}
						set_variable = {
							name = heresy_power
							value = 20
						}
					}
					5 = {
						modifier = {
							add = 45
							fervor <= 10
						}

						set_variable = {
							name = heresy_power
							value = 25
						}
					}
				}

				# Modify heresy power for pluralist/fundamentalist
				if = {
					limit = {
						has_doctrine_parameter = pluralism_pluralistic_resistant_to_heresy
					}
					change_variable = {
						name = heresy_power
						multiply = hostility_multiplier_pluralism
					}
				}
				else_if = {
					limit = {
						has_doctrine_parameter = pluralism_fundamentalist_vulnerable_to_heresy
					}
					change_variable = {
						name = heresy_power
						multiply = hostility_multiplier_fundamentalist
					}
				}

				# Changes to another religion have reduced heresy power
				# if = {
				# 	limit = {
				# 		scope:origin_faith.religion != scope:heretic_faith.religion
				# 	}
				# 	change_variable = {
				# 		name = heresy_power
				# 		multiply = 0.5
				# 	}
				# }

				#Flag the heretic faith as the parent faith's active heresy for the next 10 years.
				set_variable = {
					name = current_heresy
					value = scope:heretic_faith
					days = 3650
				}

				#Trigger the heresy outbreak event.
				scope:heretic_ruler = {
					trigger_event = {
						id = heresy.0010
						days = 3
					}
				}
			}
		}	
	}
}
