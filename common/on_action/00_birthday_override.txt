# 将魔法少女 on_action 集成进生日事件系统
# 这是来自本体的 on_birthday_childhood 完整定义，仅在 on_actions 中添加了魔法少女事件触发器

on_birthday_childhood = {
	trigger = {
		is_adult = no
		age >= childhood_education_start_age
	}
	on_actions = {
		on_birthday_education_events
		on_action_add_sexuality
		reincarnation_toy_pulse
		on_birthday_magica_mahou_shoujo # 魔法少女事件触发器
	}
	effect = {
		if = {
			limit = {
				any_parent = {
					is_playable_character = yes
					highest_held_title_tier >= tier_duchy
					any_memory = {
						memory_type = ascended_throne_memory
						has_variable = childhood_memory
						save_temporary_scope_as = throne_memory_temp
					}
				}
			}
			random_parent = {
				limit = {
					is_playable_character = yes
					highest_held_title_tier >= tier_duchy
					any_memory = {
						memory_type = ascended_throne_memory
						has_variable = childhood_memory
						save_temporary_scope_as = throne_memory_temp
					}
				}
				trigger_event = bp2_yearly.4003 # This event has further triggers, as well as a cooldown, and may still fail.
			}
		}

		if = {
			limit = {
				culture = {
					has_cultural_parameter = strong_traits_more_common
				}
				NOR = {
					has_trait = strong
					has_trait = weak
					has_trait = physique_bad
				}
			}
			random = {
				chance = {
					value = 0
					if = {
						limit = {
							prowess > 0
						}
						add = prowess
						divide = 5
					}
				}
				add_trait = strong
			}
		}

		if = {
			limit = {
				NOR = {
					has_trait = lifestyle_mystic
					has_trait = cynical
				}
				any_relation = {
					type = guardian
					culture = {
						has_cultural_parameter = mystic_trait_more_common
					}
					learning >= 12
				}
			}
			random = {
				chance = {
					value = 2
					if = {
						limit = {
							learning > 0
						}
						add = learning
						divide = 5
					}
					if = {
						limit = {
							any_relation = {
								type = guardian
								has_trait = lifestyle_mystic
							}
						}
						add = 5
					}
					if = {
						limit = {
							any_relation = {
								type = guardian
								religion = religion:taoism_religion
							}
						}
						add = 5
					}
					if = {
						limit = {
							any_relation = {
								type = guardian
								learning >= 16
							}
						}
						add = 5
					}
				}
				add_trait = lifestyle_mystic
			}
		}
		random = { # Chance for relationships for unlanded children/barons
			chance = {
				value = 10
				if = {
					limit = {
						is_hostage = yes
					}
					add = 15 # Hostages are forced to form relationships quickly
				}
				if = {
					limit = {
						OR = {
							has_sexuality = heterosexual
							has_sexuality = homosexual
							has_sexuality = bisexual
						}
						num_of_relation_crush <= 0
					}
					add = 25
				}
			}
			if = {
				limit = {
					is_available_ai_child = yes
					OR = {
						is_ruler = no
						highest_held_title_tier = tier_barony
					}
					exists = host
				}
				random_list = {
					100 = { # Gain a Crush
						trigger = {
							OR = {
								num_of_relation_crush <= 0
								has_trait = lustful
							}
							NOR = {
								has_trait = chaste
								has_trait = celibate
							}
							OR = {
								has_sexuality = heterosexual
								has_sexuality = bisexual
								has_sexuality = homosexual
							}
						}
						save_good_character_effect = {
							RELATION = crush
							SCOPE = crush
						}
						if = {
							limit = {
								exists = scope:crush
							}
							set_relation_crush = scope:crush
							random = {
								chance = 50
								scope:crush = {
									if = {
										limit = {
											is_ai = yes
											OR = {
												has_sexuality = heterosexual
												has_sexuality = bisexual
												has_sexuality = homosexual
											}
											matching_gender_and_sexuality_trigger = {
												CHARACTER_1 = scope:crush
												CHARACTER_2 = root
											}
											NOT = {
												has_relation_crush = root
											}
										}
										set_relation_crush = root
									}
									else_if = {
										limit = {
											NOT = {
												has_relation_crush = root
											}
										}
										set_variable = {
											name = unrequited_crush
											value = root
										}
									}
								}
							}
						}
					}
					10 = {
						trigger = {
							OR = {
								num_of_relation_friend < 1
								has_trait = gregarious
							}
							NOR = {
								has_trait = shy
								has_trait = callous
							}
						}
						save_good_character_effect = {
							RELATION = friend
							SCOPE = friend
						}
						if = {
							limit = {
								exists = scope:friend
								scope:friend = {
									num_of_relation_friend < 1
								}
							}
							set_relation_friend = { reason = friend_childhood_random target = scope:friend }
							add_stress = minor_stress_loss
						}
					}
					10 = {
						trigger = {
							num_of_relation_bully <= 0
						}
						save_good_character_effect = {
							RELATION = bully
							SCOPE = bully
						}
						if = {
							limit = {
								exists = scope:bully
							}
							set_relation_bully = scope:bully
							add_stress = minor_stress_gain
						}
					}
					10 = {
						trigger = {
							OR = {
								num_of_relation_victim <= 0
								has_trait = sadistic
							}
							NOR = {
								has_trait = forgiving
								has_trait = compassionate
							}
						}
						save_good_character_effect = {
							RELATION = victim
							SCOPE = victim
						}
						if = {
							limit = {
								exists = scope:victim
							}
							set_relation_victim = scope:victim
							add_stress = minor_stress_loss
						}
					}
				}
			}
		}
		# Japanese and Korean noblemen(dominate gender) learn to speak Chinese along with some other edge cases
		random = {
			chance = {
				value = 30
			}
			tgp_learn_chinese_effect_birthday = yes
		}
	}
	random_events = {
		900 = 0
		150 = childhood.2100 # Learn the Language of your Guardian
		150 = childhood.2200 # Learn the Court Language of your Guardian
		150 = childhood.2300 # Learn the Language of your parent
	}
}
